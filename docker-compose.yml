services:
  openclaw-gateway:
    build: .
    image: openclaw:local
    container_name: openclaw-gateway
    restart: unless-stopped
    network_mode: host
    # Serve the gateway on 18790. Nginx front-proxy serves the UI on 18789 and injects theme CSS.
    command: ["gateway","run","--bind","lan","--port","18790","--allow-unconfigured","--ws-log","compact"]
    env_file:
      - .env
    environment:
      # Keep the token in a normal env var (picked up by the Gateway).
      - OPENCLAW_GATEWAY_TOKEN=${OPENCLAW_GATEWAY_TOKEN:-}
      # Force container timezone to match the host (GMT-3 for Brazil).
      - TZ=${TZ:-America/Sao_Paulo}
    volumes:
      # Persist config, sessions, channel auth, workspace, logs, etc.
      - ./data:/home/node/.openclaw
      # Match host timezone inside the container.
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      # Use host OpenCode install + existing logins/config.
      - /root/.opencode:/home/node/.opencode:ro
      - /root/.opencode/bin/opencode:/usr/local/bin/opencode:ro
      # Allow docker-wrapped tools (e.g. openhue) to run host docker containers.
      - /var/run/docker.sock:/var/run/docker.sock

  openclaw-ui:
    image: nginx:alpine
    container_name: openclaw-ui
    restart: unless-stopped
    network_mode: host
    depends_on:
      - openclaw-gateway
    volumes:
      - ./data/ui/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./data/ui/theme.css:/usr/share/nginx/html/theme.css:ro
      - ./data/ui/certs:/etc/nginx/certs:ro
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  openclaw-cli:
    image: openclaw:local
    container_name: openclaw-cli
    # The Dockerfile ENTRYPOINT is `openclaw`, so `command:` maps to `openclaw <cmd...>`.
    entrypoint: ["/usr/bin/tini","--","openclaw"]
    network_mode: host
    env_file:
      - .env
    environment:
      - OPENCLAW_GATEWAY_TOKEN=${OPENCLAW_GATEWAY_TOKEN:-}
      - TZ=${TZ:-America/Sao_Paulo}
    volumes:
      - ./data:/home/node/.openclaw
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /root/.opencode:/home/node/.opencode:ro
      - /root/.opencode/bin/opencode:/usr/local/bin/opencode:ro
      - /var/run/docker.sock:/var/run/docker.sock
